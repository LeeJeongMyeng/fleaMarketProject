<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >	
<mapper namespace="fleaMarket.a03_dao.FMViewDao">
	<!-- 홍보글 상세 조회 -->
	<select id="fmView" resultType="fleamarket" parameterType="string">
		SELECT *
		FROM fleamarket
		WHERE postingNumber = #{postingNumber}			
	</select>	
	<select id="fmFileView" resultType="string" parameterType="string">
		SELECT filename
		FROM ffile
		WHERE postingNumber = #{postingNumber}
	</select>
	
	<!-- 신청글 등록 -->
	<insert id="insApp" parameterType="fapplication">
		INSERT INTO FApplication VALUES (#{postingNumber},#{email},FApplication_seq.nextval,sysdate,null)		
	</insert>
	<!-- 신청글 파일 업로드 -->
	<insert id="insAppFile" parameterType="applicationfile">
		INSERT INTO ApplicationFile VALUES (#{filename},FApplication_seq.currval)
	</insert>
	
	<!-- 받은 신청 전체 조회(최신순) + 페이징 + 제목 검색 -->
	<!-- 전체 데이터 -->
	<select id="totCnt"  resultType="int" parameterType="fapplicationsch">
		SELECT count(*)
		FROM FApplication fa, fleaMarket fm
		WHERE 1=1
		AND fa.postingNumber = fm.postingNumber(+)
		AND fm.title like '%'||#{title}||'%'
	</select>
	<select id="appReceivedList" resultType="fapplication" parameterType="fapplicationsch">
		SELECT rownum cnt,
				applicationno, applicationdate, approvalwhether,
				title, email,
				nickname
		FROM (
			SELECT rownum cnt, 
					fa.applicationno applicationno,
					fa.applicationdate applicationdate,
					fa.approvalwhether approvalwhether, 
					fm.title title, fm.email email, 
					m.nickname nickname
			FROM FApplication fa, fleaMarket fm, fleamarketmember m
			WHERE 1=1
			AND fa.postingNumber = fm.postingNumber(+)
			AND fa.email = m.email(+)
			AND fm.title like '%'||#{title}||'%'
			ORDER BY fa.applicationDate DESC
			)	
		WHERE cnt BETWEEN #{start} AND #{end}
	</select>
	<!-- 받은 신청 상세 조회 -->
	<!-- 
	<select id="appReceivedView" resultType="fapplication" parameterType="int">
		SELECT *
		FROM ApplicationFile
		WHERE applicationNo = #{applicationNo}			
	</select>
	-->
	<select id="appFileView" resultType="string" parameterType="int">
		SELECT filename
		FROM ApplicationFile
		WHERE applicationNo = #{applicationNo}
	</select>
	
	<!-- 받은 신청 승인 -->
	<update id="updateAppRe" parameterType="fapplication">
		UPDATE FApplication
		SET approvalWhether = #{approvalWhether}
		WHERE applicationNo = #{applicationNo}
	</update>
</mapper>		
		