<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="fleaMarket.a03_dao.CommunitySelectDao">
	<sql id="criteria">
		<trim prefix="(" suffix=") AND " prefixOverrides="OR">
			<choose>
				<when test="type == 'T'.toString()">
					title like '%'||#{keyword}||'%'
				</when>
				<when test="type == 'C'.toString()">
					content like '%'||#{keyword}||'%'
				</when>
				<when test="type == 'W'.toString()">
					nickname like '%'||#{keyword}||'%'
				</when>
			</choose>
		</trim>
	</sql>


	<!--전체글목록 검색+페이징+카테고리정렬 포함 -->
	<select id="getCommunityList" resultType="capplicationList">
    <![CDATA[
    SELECT  LAST.*
FROM    (SELECT ROWNUM RNUM,
                TEMP.*   
        FROM    (
        SELECT imgName,title,content,registDate,updateDate,viewCnt,nickname,CASE WHEN viewCnt >= 30 AND registDate >= SYSDATE  -1
THEN 'T' ELSE 'F'
END AS bestType
FROM fleamarketmember m, CAPPLICAION c,BOARDIMG b WHERE m.EMAIL = c.EMAIL AND c.COMMUNITYNUMBER = b.COMMUNITYNUMBER
AND 
      ]]>
		<include refid="criteria"></include>
		<![CDATA[
		c.CATEGORY = #{category}
		]]>
		<if test="shift != null and shift !=''">
			ORDER BY

			<choose>

				<when test="shift eq 'registDate'">RegistDate</when>

				<when test="shift eq 'viewCnt'"> viewCnt </when>

				<otherwise>like</otherwise>

			</choose>

		</if> 
		
		<![CDATA[
	  DESC	) TEMP 
) LAST 
        WHERE RNUM BETWEEN (#{pageNum}-1)* ${amount} AND #{pageNum} * #{amount}
     ]]>

	</select>
	<!--전체글목록 검색+페이징+카테고리정렬 포함 -->
	<select id="getBestCommunityList" resultType="capplicationList">
    <![CDATA[
    SELECT  LAST.*
FROM    (SELECT ROWNUM RNUM,
                TEMP.*   
        FROM    (
        SELECT imgName,title,content,registDate,updateDate,viewCnt,nickname,CASE WHEN viewCnt >= 30 AND registDate >= SYSDATE  -1
THEN 'T' ELSE 'F'
END AS bestType
FROM fleamarketmember m, CAPPLICAION c,BOARDIMG b 
WHERE m.EMAIL = c.EMAIL 
AND c.COMMUNITYNUMBER = b.COMMUNITYNUMBER
AND viewCnt >= 30 
AND registDate >= SYSDATE -1
AND 
      ]]>
		<include refid="criteria"></include>
		<![CDATA[
		c.CATEGORY = #{category}
		]]>
		<if test="shift != null and shift !=''">
			ORDER BY

			<choose>

				<when test="shift eq 'registDate'">RegistDate</when>

				<when test="shift eq 'viewCnt'"> viewCnt </when>

				<otherwise>like</otherwise>

			</choose>

		</if> 
		
		<![CDATA[
	  DESC	) TEMP 
)LAST 
        WHERE RNUM BETWEEN (#{pageNum}-1)* ${amount} AND #{pageNum} * #{amount}
     ]]>

	</select>

	<!-- 페이징+검색+ 포함 전체 count -->
	<select id="getCommunitySelectNum" resultType="int">
		select
		count(*)
		from fleamarketmember m, CAPPLICAION c,BOARDIMG b
		where m.EMAIL = c.EMAIL AND c.COMMUNITYNUMBER = b.COMMUNITYNUMBER AND
		c.category = #{category}
		AND
		<include refid="criteria"></include>
		1=1
	</select>
	<!-- 인기 페이징+검색+ 포함 전체 count -->
	<select id="getBestCommunityListNum" resultType="int">
		select
		count(*)
		from fleamarketmember m, CAPPLICAION c,BOARDIMG b
		where m.EMAIL = c.EMAIL AND c.COMMUNITYNUMBER = b.COMMUNITYNUMBER AND
		c.category = #{category}
		AND
		<include refid="criteria"></include>
		viewCnt >= 30
		AND registDate >= SYSDATE -1
	</select>
	
	<!-- 커뮤니티 상세 조회  -->
	<select id="getCommunityDetailList"
	resultType="capplicationList">
	SELECT
	c.COMMUNITYNUMBER,c.TITLE,c.CONTENT,c.REGISTDATE,c.UPDATEDATE,f.nickname,p.PROFILEIMG,c.EMAIL
	FROM CAPPLICAION c ,FLEAMARKETMEMBER f,BOARDIMG b
	,PROFILE p
	WHERE f.EMAIL = c.EMAIL AND c.COMMUNITYNUMBER = b.COMMUNITYNUMBER AND
	f.EMAIL = p.EMAIL
	AND c.COMMUNITYNUMBER = #{communityNumber}
</select> 
   <select id = "getCommunityImgList" resultType = "boardimg">
   SELECT b.IMGNAME FROM CAPPLICAION c,BOARDIMG b 
WHERE c.COMMUNITYNUMBER = b.COMMUNITYNUMBER 
AND c.COMMUNITYNUMBER = #{communityNumber}
   </select>
   <!-- 팔로잉 된 목록 조회 -->
   <select id = "getFollowYesOrNot" parameterType ="java.util.HashMap" resultType = "int">
   SELECT count(*) FROM FRIEND f, CAPPLICAION c
WHERE f.FOLLOWING  = c.EMAIL 
AND c.COMMUNITYNUMBER = #{communityNumber}
AND f.MYEMAIL = #{email}  
   </select>
   <!-- 좋아요 눌렀는지 여부 확인 -->
   <select id = "getLikeYesOrNot" parameterType = "java.util.HashMap">
   SELECT count(*) FROM communityHeart
WHERE communityNumber = #{communityNumber}
AND email = #{email}
</select>
   <!-- insert keyproperty 값 반환 -->
   <insert id="getInsertFriend" parameterType = "java.util.HashMap">
   INSERT INTO FRIEND VALUES(#{myEmail},#{following})
   </insert>
   <!--  -->
   <delete id="getDeleteFriend" parameterType ="java.util.HashMap">
   DELETE FROM FRIEND WHERE MYEMAIL = #{myEmail}  AND FOLLOWING =#{following} 
   </delete>
</mapper>

